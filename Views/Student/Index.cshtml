@model AttendanceSystemMVC.ViewModels.StudentDashboardVm
@inject Microsoft.AspNetCore.Identity.UserManager<AttendanceSystemMVC.Models.ApplicationUser> UserManager
@{
    ViewData["Title"] = "Student Dashboard";
    var user = await UserManager.GetUserAsync(User);
}

<div class="container-fluid mt-4">
    @if (user?.MustChangePassword == true)
    {
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning alert-dismissible fade show shadow-sm" role="alert">
                    <h5 class="alert-heading">
                        <i class="fas fa-exclamation-triangle"></i> Password Change Required
                    </h5>
                    <p class="mb-2">
                        You must change your password before continuing. This is required for first-time login.
                    </p>
                    <hr>
                    <div class="d-flex gap-2">
                        <a href="@Url.Action("ChangePassword", "Student")" class="btn btn-warning">
                            <i class="fas fa-key"></i> Change Password Now
                        </a>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="alert">
                            Remind Me Later
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Quick Actions -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h5>
                    <div class="d-flex flex-wrap gap-2">
                        <a asp-action="RegisterCourses" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Register for Courses
                        </a>
                        <a asp-action="Timetable" class="btn btn-info">
                            <i class="fas fa-calendar-week"></i> View Timetable
                        </a>
                        <a asp-action="MonthlyReport" asp-route-year="@DateTime.Now.Year"
                            asp-route-month="@DateTime.Now.Month" class="btn btn-success">
                            <i class="fas fa-chart-bar"></i> Monthly Report
                        </a>
                        <a asp-action="ChangePassword" class="btn btn-warning">
                            <i class="fas fa-key"></i> Change Password
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm mb-4"
                style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-0"><i class="fas fa-user-graduate"></i> @Model.WelcomeMessage</h2>
                            <p class="mb-0 mt-2">
                                <strong>Roll Number:</strong> @Model.Student?.RollNumber
                                <span class="ms-3"><strong>Section:</strong> @Model.Student?.Section?.Name</span>
                                @if (Model.CurrentSession != null)
                                {
                                    <span class="ms-3"><strong>Session:</strong> @Model.CurrentSession.Name</span>
                                }
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <h4 class="mb-0">@DateTime.Now.ToString("dddd, MMMM dd")</h4>
                            <p class="mb-0">@DateTime.Now.ToString("yyyy")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@Model.EnrolledCourses.Count</h4>
                            <p class="mb-0">Enrolled Courses</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@Model.TodaySchedules.Count</h4>
                            <p class="mb-0">Classes Today</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-day fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@Model.AttendanceStats.AttendancePercentage%</h4>
                            <p class="mb-0">This Month</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div
                class="card text-white @(Model.AttendanceStats.AttendancePercentage >= 75 ? "bg-success" : "bg-warning")">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@Model.AttendanceStats.PresentClasses/@Model.AttendanceStats.TotalClasses</h4>
                            <p class="mb-0">Present/Total</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clipboard-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Today's Schedule -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Today's Schedule</h5>
                </div>
                <div class="card-body">
                    @if (Model.TodaySchedules.Any())
                    {
                        @foreach (var schedule in Model.TodaySchedules)
                        {
                            var now = DateTime.Now.TimeOfDay;
                            var status = "";
                            var statusClass = "";

                            if (now < schedule.StartTime)
                            {
                                status = "Upcoming";
                                statusClass = "bg-primary";
                            }
                            else if (now >= schedule.StartTime && now <= schedule.EndTime)
                            {
                                status = "Ongoing";
                                statusClass = "bg-success";
                            }
                            else
                            {
                                status = "Completed";
                                statusClass = "bg-secondary";
                            }

                            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                <div>
                                    <h6 class="mb-1">@schedule.Course?.Name</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> @schedule.StartTime.ToString(@"hh\:mm") -
                                        @schedule.EndTime.ToString(@"hh\:mm")
                                    </small>
                                </div>
                                <span class="badge @statusClass text-white">@status</span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No classes scheduled for today.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Monthly Attendance Summary -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Monthly Attendance Summary</h5>
                </div>
                <div class="card-body">
                    @if (Model.AttendanceStats.TotalClasses > 0)
                    {
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <h3 class="text-success">@Model.AttendanceStats.PresentClasses</h3>
                                <p class="mb-0">Present</p>
                            </div>
                            <div class="col-6">
                                <h3 class="text-danger">@Model.AttendanceStats.AbsentClasses</h3>
                                <p class="mb-0">Absent</p>
                            </div>
                        </div>

                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                style="width: @Model.AttendanceStats.AttendancePercentage%"
                                aria-valuenow="@Model.AttendanceStats.AttendancePercentage" aria-valuemin="0"
                                aria-valuemax="100">
                                @Model.AttendanceStats.AttendancePercentage%
                            </div>
                        </div>

                        @if (Model.AttendanceStats.AttendancePercentage < 75)
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Warning:</strong> Your attendance is below 75%. Please improve your attendance.
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>Good:</strong> Your attendance is satisfactory.
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No attendance records found for this month.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Enrolled Courses -->
    @if (Model.EnrolledCourses.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-book"></i> Enrolled Courses</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Course Code</th>
                                        <th>Course Name</th>
                                        <th>Credit Hours</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var course in Model.EnrolledCourses)
                                    {
                                        <tr>
                                            <td><span class="badge bg-primary">@course.Code</span></td>
                                            <td><strong>@course.Name</strong></td>
                                            <td>@course.CreditHours</td>
                                            <td>
                                                <a asp-action="MonthlyReport" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-chart-bar"></i> View Report
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-chart-bar fa-2x text-info mb-3"></i>
                    <h6>Monthly Report</h6>
                    <a asp-action="MonthlyReport" class="btn btn-outline-info btn-sm">
                        View Report
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-alt fa-2x text-success mb-3"></i>
                    <h6>Timetable</h6>
                    <a asp-action="Timetable" class="btn btn-outline-success btn-sm">
                        View Schedule
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-book fa-2x text-primary mb-3"></i>
                    <h6>My Courses</h6>
                    <a asp-action="Courses" class="btn btn-outline-primary btn-sm">
                        View Courses
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar fa-2x text-warning mb-3"></i>
                    <h6>Sessions</h6>
                    <a asp-action="Sessions" class="btn btn-outline-warning btn-sm">
                        View Sessions
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .btn {
        border-radius: 8px;
    }

    .badge {
        border-radius: 6px;
    }

    .progress {
        border-radius: 10px;
    }

    .progress-bar {
        border-radius: 10px;
    }
</style>